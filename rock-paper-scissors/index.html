<!--
  Rock, Paper, Scissors
  Author: Preetam J. D'Souza

  Originally implemented for the Rosetta Code task:
  http://rosettacode.org/wiki/Rock-paper-scissors
-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
  </head>
  <body>
    <button id="r">rock</button>
    <button id="p">paper</button>
    <button id="s">scissors</button>
    <div id="log">
      <p>Round 1: rock, paper, scissors?</p>
    </div>

    <script>
      // -- util ---------------------------------------------------------------

      function println(s) {
        const log = document.getElementById('log');
        const p = document.createElement('p');
        p.innerHTML = s;
        log.appendChild(p);
      }

      // -- stat ---------------------------------------------------------------

      function histToProb(hist) {
        const events = hist.reduce((acc, freq) => acc + freq);
        return hist.map(x => events > 0 ? x / events : 1 / hist.length)
      }

      function weightedRandSample(hist) {
        // A weighted random sample can be implemented by
        // checking which prob interval a sample ~ U(0, 1) falls within:
        //
        // 0                            1
        // |---|------|-- ... ----------|
        //     ^      ^                 ^
        //     p[0]   p[0] + p[1]       p[0] + ... + p[n]
        const p = histToProb(hist);
        let sample = -1;
        for (rand = Math.random(); rand >= 0; rand -= p[++sample]);
        return sample;
     }

      // -- pure ---------------------------------------------------------------

      const hands = ['rock', 'paper', 'scissors'];
      const handToChoice = (hand) => hands.findIndex(h => h === hand);
      const choiceThatBeats = (c) => (c + 1) % 3;
      const beats = (c1, c2) => choiceThatBeats(c2) === c1;

      function judge(userHand, aiHand) {
        const user = handToChoice(userHand);
        const ai = handToChoice(aiHand);
        let winner;
        let txt = `Your ${userHand} draws the AI's ${aiHand}!`;
        if (beats(user, ai)) {
          winner = 'user';
          txt = `Your ${userHand} beats the AI's ${aiHand} — you win!`;
        } else if (beats(ai, user)) {
          winner = 'ai';
          txt = `The AI's ${aiHand} beats your ${userHand} — you lose!`;
        }
        return { winner, toString: () => txt };
      }

      function playRound(state, userHand, aiHand) {
        const nextState = {...state};

        const result = judge(userHand, aiHand);
        if (result.winner) nextState.score[result.winner]++;
        nextState.userHist[handToChoice(userHand)]++;

        return { nextState, result };
      }

      const aiPick = hist => hands[choiceThatBeats(weightedRandSample(hist))];
      const rounds = (state) => state.userHist.reduce((acc, freq) => acc + freq);
      const prompt = (state) => `Round ${rounds(state) + 1}: rock, paper, scissors?`;

      // -- impure! ------------------------------------------------------------

      let state = {
        score: { 'user': 0, 'ai': 0 },
        userHist: [0, 0, 0] // histogram of hands played by user
      };

      function play(hand) {
        const { nextState, result } = playRound(state, hand, aiPick(state.userHist));
        state = nextState;
        println(result);
        println(prompt(state));
      }

      document.getElementById('r').onclick = () => play('rock');
      document.getElementById('p').onclick = () => play('paper');
      document.getElementById('s').onclick = () => play('scissors');
    </script>
  </body>
</html>
